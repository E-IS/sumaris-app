
<ion-content>



  <app-sub-batch-form #form
                      [debug]="debug"
                      [acquisitionLevel]="SORTING_BATCH_INDIVIDUAL"
                      [program]="program"
                      [showParent]="showParentColumn"
                      [showTaxonName]="showTaxonNameColumn"
                      [availableParents]="availableParents"
                      [displayParentPmfm]="displayParentPmfm"
  ></app-sub-batch-form>


  <ion-grid>
    <ion-row>
      <ion-col>
        <button mat-button (click)="addBatch()" >
          <span translate>COMMON.BTN_VALIDATE</span>
        </button>
      </ion-col>
      <ion-col>
        <button mat-button (click)="test()" >
          <span >Test</span>
        </button>
      </ion-col>
    </ion-row>
  </ion-grid>

  <mat-table [dataSource]="dataSource" class="table-sub-batches" matSort matSortActive="rankOrder" matSortDirection="asc"
             matSortDisableClear [trackBy]="trackByFn">

    <ng-container matColumnDef="select">
      <mat-header-cell  *matHeaderCellDef>
        <mat-checkbox (change)="$event ? masterToggle() : null" [checked]="selection.hasValue() && isAllSelected()"
                      [indeterminate]="selection.hasValue() && !isAllSelected()">
        </mat-checkbox>
      </mat-header-cell>
      <mat-cell  *matCellDef="let row">
        <mat-checkbox (click)="$event.stopPropagation()" (change)="$event ? selection.toggle(row) : null" [checked]="selection.isSelected(row)">
        </mat-checkbox>
      </mat-cell>
    </ng-container>

    <!-- rankOrder Column = id -->
    <ng-container matColumnDef="id">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        <ion-label *ngIf="!loading">#</ion-label>
        <ion-spinner [ngClass]="{'center':true}" *ngIf="loading"></ion-spinner>
      </mat-header-cell>
      <mat-cell *matCellDef="let row">{{ row.currentData?.rankOrder }}</mat-cell>
    </ng-container>

    <!-- parent -->
    <ng-container matColumnDef="parent">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        <ion-label>{{ (displayParentPmfm && getPmfmColumnHeader(displayParentPmfm) ||
          'TRIP.BATCH.TABLE.PARENT') | translate }}</ion-label>
      </mat-header-cell>
      <mat-cell *matCellDef="let row">
        {{ parentToString(row.currentData?.parent) }}
      </mat-cell>
    </ng-container>

    <!-- taxon name (scientific species) -->
    <ng-container matColumnDef="taxonName">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        <ion-label translate>TRIP.BATCH.TABLE.TAXON_NAME</ion-label>
      </mat-header-cell>
      <mat-cell *matCellDef="let row">
        {{referentialToString(row.currentData?.taxonName)}}
      </mat-cell>

    </ng-container>

    <!-- Pmfms columns -->
    <ng-container *ngFor="let pmfm of pmfms | async" [matColumnDef]="pmfm.pmfmId.toString()">
      <mat-header-cell *matHeaderCellDef mat-sort-header [class.mat-cell-date-time]="pmfm.isDate">
        <ion-label>{{getPmfmColumnHeader(pmfm)}}
          <small *ngIf="pmfm.hasUnit"><br />({{pmfm.unit}})</small>
        </ion-label>
      </mat-header-cell>
      <mat-cell *matCellDef="let row" [class.mat-cell-date-time]="pmfm.isDate">
        {{measurementValueToString(row.currentData.measurementValues[pmfm.pmfmId], pmfm) }}
      </mat-cell>
    </ng-container>

    <!-- Comment column -->
    <ng-container matColumnDef="comments">
      <mat-header-cell *matHeaderCellDef class="hidden-xs hidden-sm">
        <ion-label translate>REFERENTIAL.COMMENTS</ion-label>
      </mat-header-cell>
      <mat-cell *matCellDef="let row" class="hidden-xs hidden-sm">
        {{measurementValueToString(row.currentData?.comments)}}
      </mat-cell>
    </ng-container>

    <!-- Actions buttons column -->
    <ng-container matColumnDef="actions">
      <mat-header-cell *matHeaderCellDef>
      </mat-header-cell>
      <mat-cell *matCellDef="let row">
        <!-- delete  -->
        <button mat-icon-button small color="light" [title]="'COMMON.BTN_DELETE'|translate"
                (click)="cancelOrDelete($event, row)">
          <mat-icon>delete_outline</mat-icon>
        </button>
      </mat-cell>
    </ng-container>

    <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
    <mat-row *matRowDef="let row; columns: displayedColumns;"
             (click)="clickRow($event, row)"></mat-row>
  </mat-table>
</ion-content>
