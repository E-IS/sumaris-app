<form class="form-container" [formGroup]="form" (ngSubmit)="doSubmit($event, form.value)">

  <!-- error -->
  <ion-item *ngIf="error && showError" visible-xs visible-sm>
    <ion-icon color="danger" slot="start" name="alert"></ion-icon>
    <ion-label color="danger" class="error" [innerHTML]="error|translate"></ion-label>
  </ion-item>

  <ion-grid>

    <!-- parent batch-->
    <ion-row no-padding *ngIf="showParent">
      <ion-col size="12" size-md="2" size-lg="3">
        <ion-label float-end>
          <span *ngIf="displayParentPmfm">{{getPmfmColumnHeader(displayParentPmfm)}}</span>
          <span *ngIf="!displayParentPmfm" translate>TRIP.BATCH.TABLE.PARENT</span>
        </ion-label>
      </ion-col>
      <ion-col>
        <mat-form-field>
          <input matInput formControlName="parent"
                 [matAutocomplete]="autoParent"
                 (click)="onShowParentDropdown.next()"
                 (keyup.arrowdown)="onShowParentDropdown.next()"
                 [placeholder]="displayParentPmfm && getPmfmColumnHeader(displayParentPmfm) || ('TRIP.BATCH.TABLE.PARENT' | translate)"
                 tabindex="1"
                 required>
          <mat-error *ngIf="form.controls.parent.hasError('required')" translate>ERROR.FIELD_REQUIRED
          </mat-error>
          <mat-error *ngIf="form.controls.parent.hasError('entity')" translate>ERROR.FIELD_INVALID</mat-error>

          <button type="button" matSuffix (click)="onShowParentDropdown.next()" mat-icon-button tabindex="-1">
            <mat-icon>keyboard_arrow_down</mat-icon>
          </button>
        </mat-form-field>

        <mat-autocomplete #autoParent="matAutocomplete" [displayWith]="parentToString">
          <ion-row class="mat-autocomplete-header">
            <ion-col size="1">
              <ion-text>#</ion-text>
            </ion-col>
            <ion-col>
              <ion-text translate>TRIP.BATCH.TABLE.PARENT</ion-text>
            </ion-col>
          </ion-row>
          <mat-option *ngFor="let batch of $filteredParents | async" [value]="batch" no-padding>
            <ion-row>
              <ion-col size="1" [innerHTML]="batch.rankOrder"></ion-col>
              <ion-col>
                <span
                  [innerHTML]="parentToString(batch) | highlight: {search: form.controls.parent.value }"></span>
              </ion-col>
            </ion-row>
          </mat-option>
        </mat-autocomplete>
      </ion-col>
      <ion-col size="auto" no-padding>
        <button mat-icon-button tabindex="-1" [title]="'COMMON.BTN_ADD'|translate" (click)="addParentBatchModal()"
                type="button">
          <mat-icon>add</mat-icon>
        </button>
      </ion-col>
    </ion-row>

    <!-- EspÃ¨ce scientifique -->
    <ion-row no-padding *ngIf="showTaxonName">
      <ion-col size="12" size-md="2" size-lg="3">
        <ion-label float-end translate>TRIP.BATCH.EDIT.TAXON_NAME</ion-label>
      </ion-col>
      <ion-col>
        <mat-form-field floatLabel="never">
          <input matInput formControlName="taxonName"
                 [matAutocomplete]="autoTaxonName"
                 [appAutofocus]="!showTaxonGroup && showTaxonName"
                 [placeholder]="'TRIP.BATCH.TABLE.TAXON_NAME_PLACEHOLDER'|translate"
                 (blur)="applyImplicitValue('taxonName')"
                 tabindex="2"
                 required>
          <mat-error *ngIf="form.controls.taxonName.hasError('required')" translate>ERROR.FIELD_REQUIRED</mat-error>
        </mat-form-field>

        <mat-autocomplete autoActiveFirstOption #autoTaxonName="matAutocomplete" [displayWith]="referentialToString">
          <ion-row class="mat-autocomplete-header">
            <ion-col size="3">
              <ion-text translate>REFERENTIAL.LABEL</ion-text>
            </ion-col>
            <ion-col>
              <ion-text translate>REFERENTIAL.NAME</ion-text>
            </ion-col>
          </ion-row>
          <mat-option *ngFor="let item of $taxonNames| async" [value]="item" no-padding>
            <ion-row>
              <ion-col size="3"
                       [innerHTML]="item.label | highlight: {search: form.controls.taxonName.value }"></ion-col>
              <ion-col [innerHTML]="item.name | highlight: {search: form.controls.taxonName.value }"></ion-col>
            </ion-row>
          </mat-option>
        </mat-autocomplete>
      </ion-col>
    </ion-row>

    <!-- Measurements -->
    <ion-row>
      <ion-col size="12" size-md="2" size-lg="3" align-self-end>
        <ion-label float-end translate>LANDING.EDIT.OTHER_FEATURES</ion-label>
      </ion-col>
      <ion-col>

        <ion-spinner *ngIf="loading"></ion-spinner>

        <!-- pmfms -->
        <mat-form-field-measurement *ngFor="let pmfm of $pmfms | async; index as i;"
                                    [pmfm]="pmfm"
                                    [formControl]="form.controls.measurementValues.controls[pmfm.pmfmId]"
                                    [compact]="compact"
                                    [tabindex]="10 + i*2"
                                    [floatLabel]="floatLabel">
        </mat-form-field-measurement>
      </ion-col>
    </ion-row>

  </ion-grid>

</form>
